sap.ui.define(["sap/ui/core/Fragment","sap/ui/model/Filter","sap/m/Token","sap/ui/model/FilterOperator","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/ValueState","com/aymax/apave/sd/BureauOrdre/BureauOrdreCreate/model/formatter","sap/m/MessagePopover","sap/m/MessageItem","sap/ui/core/Core","sap/ui/core/message/Message","sap/ui/core/MessageType","./Utils/MessagesPopOverHandler","./Utils/pjCreate"],function(e,t,r,s,i,a,o,g,n,l,d,c,u,p,h,v,y){"use strict";return i.extend("com.aymax.apave.sd.BureauOrdre.BureauOrdreCreate.controller.Main_VIEW",{formatter:l,MsgPopOverHdler:v,pjCreateHdler:y,onInit:function(){this._wizard=this.byId("CreateProductWizard");this._oNavContainer=this.byId("wizardNavContainer");this._oWizardContentPage=this.byId("wizardContentPage");this.oBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();this._MessageManager=u.getMessageManager();this.getView().setModel(this._MessageManager.getMessageModel(),"Messages");this.getView().byId("pjUploader").setUploadUrl("/sap/opu/odata/sap/ZSDGW_OFFICE_ORDER_APP_SRV/Pieces_jointes");this.getView().byId("D1").setDateValue(new Date)},onAfterRendering:function(){var e=this;this.getView().byId("pjUploader").getToolbar().getTitleControl().setBusy(true);this.getView().byId("pjUploader").getToolbar().getTitleControl().setText(this.getOwnerComponent().getModel("i18n").getProperty("Coverphoto"));this.getView().byId("pjUploader").getToolbar().getTitleControl().setBusy(false);this.getView().byId("CreateProductWizard")._getNextButton().setText(this.getOwnerComponent().getModel("i18n").getProperty("AffecterServices"));this.oView.byId("idServiceTable").addEventDelegate({onAfterRendering:function(t){var r="";var s="";var i=e.oView.byId("idServiceTable").getItems();for(var a=0;a<i.length;a++){var o=i[a].getBindingContext().getProperty("Zcserv");r=[new sap.ui.model.Filter("Zcserv",sap.ui.model.FilterOperator.EQ,o)];s=i[a].getCells()[3];var g=s.getBinding("items");g.filter(r)}}})},handleWizardCreate:function(e){if(this.checkInputsErrors()){this.getView().byId("messagePopoverBtn").setBusy(true);setTimeout(function(){this.getView().byId("messagePopoverBtn").firePress()}.bind(this),100);this.getView().byId("messagePopoverBtn").setBusy(false)}else{var t=this.getView().getModel("CreateModel").getData();var r={};r=t;var s=this.getView().byId("Ex").getValue();var i=false;var a="";var o="";if(t.Zlibcat!==""&&t.ZlibNr!==""&&t.Zscatref!==""&&s!==""){var g=this.getView().byId("idServiceTable");for(var n=0;n<g.getItems().length;n++){var d=g.getItems()[n].getBindingContext().getObject();if(d.Ztypepilote){n=g.getItems().length;i=true;a=d.Zcserv;o=d.Zlibserv}}}if(i){r.Zdc=l.toBoolean(t.Zdc);r.Zdi=l.toBoolean(t.Zdi);r.Zdu=l.toBoolean(t.Zdu);t.Zdar=l.dateFormatter(this.getView().byId("D1").getDateValue());t.Zdec=l.dateFormatter(this.getView().byId("D3").getDateValue());t.Zdexp=l.dateFormatter(this.getView().byId("D4").getDateValue());t.Zcserv=a;t.Zlibserv=o;t.Zstatid="001";t.Zstatde="Crée";r.Zlibclient=this.getView().byId("Ex").getValue();var c=(new Date).toLocaleString();t.DateCre=c.substr(6,4)+c.substr(3,2)+c.substr(0,2);var u=this.getView().getModel();this.getView().setBusy(true);u.create("/Document_entrantSet",r,{success:function(e,t){this.pjCreateHdler.uploadFilesFromPC.apply(this,[e.Zrefde]);var r=this.getView().byId("idServiceTable");for(var s=0;s<r.getItems().length;s++){var i=r.getItems()[s].getBindingContext().getObject();i.Zrefde=e.Zrefde;var a={};a.Zrefde=e.Zrefde;a.Ztypepilote=i.Ztypepilote;a.Ztypeselection=i.Ztypeselection;a.Zcserv=i.Zcserv;a.Zlibserv=i.Zlibserv;a.Zemployee=i.Zemployee.filter(e=>e).join(",");if(i.Ztypepilote||i.Ztypeselection){u.create("/DOC_SERVICESSet",a,{success:function(e,t){this.MsgPopOverHdler.removeAllMsgsByType.apply(this,[h.Error]);this.addCreatedDocSuccesMsg(a.Zrefde);this.getView().getModel("CreateModel").setData({});u.resetChanges();this.getView().setBusy(false)}.bind(this),error:function(e){this.getView().setBusy(false)}.bind(this)})}}}.bind(this),error:function(e){this.getView().setBusy(false)}.bind(this)})}}},onChangeCategorieFilter:function(e){var t=this.getView().byId("subCategoryId");var r=e.getSource().getSelectedKey();t.setSelectedKey();this.getOwnerComponent().getModel("SubcategoryModel").setData(null);this.getOwnerComponent().getModel().read("/CATEGORYSet('"+r+"')/SUB_CATEGORYSet",{success:function(e,r){this.getView().byId("subCategoryId").setEnabled(true);this.getOwnerComponent().getModel("SubcategoryModel").setData(e.results);t.setModel(this.getOwnerComponent().getModel("SubcategoryModel"));t.bindAggregation("items","/",function(e,t){var r=new sap.ui.core.Item({key:encodeURI(t.getProperty("Scatref")),text:t.getProperty("Libscat")});return r})}.bind(this),error:function(e){}});var s=e.getSource().getSelectedItem().getCustomData();var i=s.find(e=>e.getKey()==="valCat").getValue();this.getView().getModel("CreateModel").setProperty("/ZcatVal",i);this.MsgPopOverHdler.removeMsgWithTarget.apply(this,[e.getSource().getId()]);e.getSource().setValueState("None")},handlesuggestionItemSelected:function(e){var t=e.getParameters().selectedItem.getBindingContext().getObject();if(t){this.MsgPopOverHdler.removeMsgWithTarget.apply(this,[e.getSource().getId()]);e.getSource().setValueState("None");var r=t.ClientName;var s=t.Contactclient;var i=t.Kunnr;this.getView().byId("Client").setValue(r);this.getView().byId("Client").setValue(i)}},onSuggest:function(e){var t=e.getSource();var r=t.getValue();var s=t.getBindingInfo("suggestionItems").template;var i=[new sap.ui.model.Filter("Expediteur",sap.ui.model.FilterOperator.EQ,r)];t.bindAggregation("suggestionItems",{path:"/ClientSet",template:s,filters:i});t.setFilterFunction(function(e,t){return t.getText()})},onSelectionChange:function(e){var t=e.getSource().getSelectedKeys();var r=e.getSource().getParent().getCells()[0];var s=e.getSource().getParent().getCells()[1];var i=e.getSource().getParent().getCells()[2];var a=e.getSource().getBindingContext().getObject();var o=this.getView().getModel("CreateModel").getData();if(r.getSelected()){o.Zcservpi=a.Zcserv;o.Zlibservpi=a.Zlibserv}else if(s.getSelected()){this.MsgPopOverHdler.removeMsgWithTarget.apply(this,["selection_msg"]);o.Zcserv=a.Zcserv;o.Zlibserv=a.Zlibserv}},onSelectionFinish:function(e){var t=e.getSource().getBindingContext().getObject(),r=e.getSource().getSelectedKeys().filter(e=>e),s=this.getView();if(t.Ztypepilote&&r.length>0){e.getSource().setValueState("None");this.MsgPopOverHdler.removeMsgWithTarget.apply(this,[this.getView().byId("idServiceTable").getId()])}},onPiloteSelected:function(e){var t=e.getSource().getBindingContext().getObject().Zcserv;var r=this.getView().byId("MultiBoxCategorie");var s=this.getView().byId("idServiceTable");if(e.getParameter("selected")){this.MsgPopOverHdler.removeMsgWithTarget.apply(this,[s.getId()]);for(var i=0;i<s.getItems().length;i++){var a=s.getItems()[i];if(a.getBindingContext().getObject().Zcserv===t){a.getCells()[1].setEnabled(false);a.getCells()[1].setSelected(false);a.getCells()[3].setEnabled(true)}}}else{for(var o=0;o<s.getItems().length;o++){var g=s.getItems()[o];if(g.getBindingContext().getObject().Zcserv===t){g.getCells()[1].setEnabled(true);g.getCells()[3].setEnabled(false)}}}},onServiceSelectionSelected:function(e){if(e.getParameter("selected")){e.getSource().getParent().getCells()[3].setEnabled(true)}else{e.getSource().getParent().getCells()[3].setEnabled(false)}},checkInputsErrors:function(){var e=false;this.checkWizardStepOneErrors();this.checkWizardStepTwoErrors();var t=this._MessageManager.getMessageModel().getData().filter(e=>e.type===h.Error);if(t.length>0){e=true}return e},checkWizardStepOneErrors:function(){this.checkMandatoryFieldById("categorieComboBox");this.checkMandatoryFieldById("subCategoryId");this.checkMandatoryFieldById("natureReceptionCombo");var e=this.getView().byId("subCategoryId");if(e.getSelectedItem().getText()!=="AUTRES"){this.checkMandatoryFieldById("typeObjetId")}this.checkMandatoryFieldById("Ex")},checkMandatoryFieldById:function(e){var t=this;var r={};var s=this.getView().byId(e);if(s.getEnabled()){var i=s.getMetadata().getName();switch(i){case"sap.m.ComboBox":var a=s.getSelectedKey();if(!a){r={sMsgTitle:s.getParent().getLabel().getText(),sMsgType:h.Error,sAddText:"Ce Champs est obligatoire",sTarget:s.getId(),oProcessor:t.getView().getModel(),code:"FirstStep"};t.MsgPopOverHdler.addMessageWithTarget.apply(this,[r])}break;case"sap.m.Input":var o=s.getValue();if(!o){r={sMsgTitle:s.getParent().getLabel().getText(),sMsgType:h.Error,sAddText:"Ce Champs est obligatoire",sTarget:s.getId(),oProcessor:t.getView().getModel(),code:"FirstStep"};t.MsgPopOverHdler.addMessageWithTarget.apply(this,[r]);break}default:}}},onChangeSsCategorie:function(e){var t=this.getView().byId("subCategoryId");var r=e.getSource().getSelectedKey();this.getOwnerComponent().getModel("TypeObjectModel").setData(null);var s=this.getView().byId("typeObjetId");s.setSelectedKey();this.getOwnerComponent().getModel().read("/SUB_CATEGORYSet('"+r+"')/SubCategory_TO_TYPEOBJECT",{success:function(e,t){this.getOwnerComponent().getModel("TypeObjectModel").setData(e.results);s.setModel(this.getOwnerComponent().getModel("TypeObjectModel"));s.bindAggregation("items","/",function(e,t){var r=new sap.ui.core.Item({key:t.getProperty("Reftypobj"),text:t.getProperty("Libtypobj")});return r})}.bind(this),error:function(e){}});this.MsgPopOverHdler.removeMsgWithTarget.apply(this,[e.getSource().getId()]);e.getSource().setValueState("None")},onChangeNatureRecep:function(e){this.MsgPopOverHdler.removeMsgWithTarget.apply(this,[e.getSource().getId()]);e.getSource().setValueState("None")},checkWizardStepTwoErrors:function(){this.checkAtLeastOnePiloteIsSelected();this.checkAtLeastOneSelectionIsSelected()},checkAtLeastOnePiloteIsSelected:function(){var e=this,t={},r=false,s=this.getView().byId("idServiceTable"),i=-1;for(var a=0;a<s.getItems().length;a++){var o=s.getItems()[a].getBindingContext().getObject();if(o.Ztypepilote){r=true;i=a;break}}if(!r){t={sMsgTitle:"Service Pilote",sMsgType:h.Error,sAddText:"Un Service Pilote doit être selectionnné",sTarget:s.getId(),oProcessor:e.getView().getModel(),code:"SecondStep"};e.MsgPopOverHdler.addMessageWithTarget.apply(this,[t])}else{var g=s.getItems()[i].getBindingContext().getProperty("Zemployee").filter(e=>e);var n=g.length>0;if(!n){t={sMsgTitle:"Service Pilote : Employés",sMsgType:h.Error,sAddText:"Un Service Pilote doit être avoir au moins un employé",sTarget:s.getId(),oProcessor:e.getView().getModel(),code:"SecondStep"};e.MsgPopOverHdler.addMessageWithTarget.apply(this,[t]);s.getItems()[i].getCells()[3].setValueState("Error")}}},checkAtLeastOneSelectionIsSelected:function(){var e=this,t={},r=this.getView().byId("idServiceTable"),s=-1;for(var i=0;i<r.getItems().length;i++){var a=r.getItems()[i].getBindingContext().getObject();if(a.Ztypeselection){s=i;var o=r.getItems()[s].getBindingContext().getProperty("Zemployee").filter(e=>e);var g=o.length>0;if(!g){t={sMsgTitle:"Service Seléction : Employés",sMsgType:h.Error,sAddText:"Un Service Seléction doit être avoir au moins un employé",sTarget:"selection_msg",oProcessor:e.getView().getModel(),code:"SecondStep"};e.MsgPopOverHdler.addMessageWithTarget.apply(this,[t]);r.getItems()[s].getCells()[3].setValueState("Error")}}}},addCreatedDocSuccesMsg:function(e){var t=this._MessageManager.getMessageModel().getData();var r=t.findIndex(t=>t.getTarget()===e)>-1;if(!r){var s=this.getView().getModel();this._MessageManager.addMessages(new p({message:"Succès de création",type:h.Success,additionalText:"le Document "+e+" a éte crée avec succès",target:e,processor:s,code:"DocCreated"}));this.reverserMsgsOrder();this.getView().byId("messagePopoverBtn").setBusy(true);setTimeout(function(){this.getView().byId("messagePopoverBtn").firePress()}.bind(this),100);this.getView().byId("messagePopoverBtn").setBusy(false);this.getView().byId("CreateProductWizard").goToStep(this.getView().byId("FirstStep"))}},reverserMsgsOrder:function(){var e=this._MessageManager.getMessageModel().getData();this._MessageManager.removeAllMessages();for(var t=e.length-1;t>-1;t--){var r=e[t];this._MessageManager.addMessages(new p({message:r.message,type:r.type,additionalText:r.additionalText,target:r.target,processor:r.processor,code:r.code}))}}})});